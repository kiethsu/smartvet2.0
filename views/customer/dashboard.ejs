<%
  function formatVisitDate(date) {
    const d = new Date(date);
    const month = d.toLocaleString('en-US', { month: 'long' }).toLowerCase();
    const day = d.getDate();
    const year = d.getFullYear();
    return `${month} ${day} ${year}`;
  }
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Fonts & Bootstrap -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #1E88E5;
      --primary-dark: #0D47A1;
      --accent: #90CAF9;
      --white: #ffffff;
      --text: #333;
      --background-color: #f4f7fa;
      --card-bg: #ffffff;
      --border-color: rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--text);
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    }
    body { min-height: 100vh; }
    .page-wrapper {
      min-height: 100vh;
      padding: 0 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dashboard-main {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 0 12px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      box-shadow:
        0 4px 24px 0 rgba(30, 136, 229, 0.12),
        0 1.5px 12px 0 rgba(32, 39, 55, 0.08);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 0;
    }

    /* === Welcome Card === */
    .welcome-card {
      position: relative;
      display: flex;
      align-items: center;
      padding: 24px;
      flex: 2 1 360px;
      min-width: 280px;
      max-width: 100%;
      background: linear-gradient(135deg, #1E88E5 0%, #42A5F5 50%, #64B5F6 100%);
      color: var(--white);
      border-radius: 16px;
      overflow: hidden;
    }
    .welcome-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 60%);
      mix-blend-mode: overlay;
      pointer-events: none;
      animation: gradientShift 20s ease infinite;
      z-index: 0;
    }
    @keyframes gradientShift {
      0% { filter: brightness(1); }
      50% { filter: brightness(1.06); }
      100% { filter: brightness(1); }
    }
    .bubbles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .bubble {
      position: absolute;
      background: rgba(255,255,255,0.08);
      border-radius: 50%;
      filter: blur(4px);
      animation: rise 15s linear infinite;
    }
    @keyframes rise {
      0% {
        transform: translateY(100%) scale(0.8);
        opacity: 0;
      }
      10% { opacity: 0.3; }
      50% { opacity: 0.15; }
      100% {
        transform: translateY(-120%) scale(1.2);
        opacity: 0;
      }
    }
    .pet-anim {
      flex: 0 0 100px;
      margin-right: 16px;
      position: relative;
      z-index: 1;
    }
    .pet-svg {
      width: 100px; height: 100px;
    }
    .pad {
      fill: #fff; opacity: 0.9;
      animation: pulsePad 3s ease-in-out infinite;
    }
    .center-pad {
      fill: #fff; opacity: 1;
      animation: beatCenter 1.8s ease-in-out infinite;
    }
    @keyframes pulsePad {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    @keyframes beatCenter {
      0%,100% { transform: scale(1); }
      25%,75% { transform: scale(1.08); }
      50% { transform: scale(1); }
    }
    .welcome-text {
      position: relative;
      z-index: 1;
      max-width: calc(100% - 280px);
      min-width: 150px;
    }
    .welcome-title {
      font-size: 1.25rem;
      font-weight: 500;
      margin: 0;
    }
    .welcome-user {
      font-size: 2rem;
      font-weight: 700;
      margin: 4px 0;
      text-transform: lowercase;
    }
    .welcome-msg {
      font-size: 1rem;
      opacity: .95;
      margin: 8px 0 16px;
      line-height: 1.4;
    }
    .welcome-card .btn {
      background: var(--white);
      color: var(--primary-dark);
      font-weight: 600;
      padding: 8px 24px;
      border-radius: 24px;
      border: none;
      transition: background .15s;
      position: relative;
      z-index: 1;
    }
    .welcome-card .btn:hover { background: #e3f0fc; }

    /* === Calendar & Visits === */
    .calendar-card {
      flex: 1 1 300px;
      min-width: 280px;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      padding: 0; /* restored original to bring back header look */
    }
    .custom-header {
      background: #f1f5fa;
      color: #444;
      font-weight: 600;
      font-size: .95rem;
      border-radius: 12px 12px 0 0;
      padding: 12px 18px;
      text-align: left;
      letter-spacing: .4px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    .calendar-inner {
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:700;
      color:var(--primary-dark);
      font-size:1.02rem;
      margin-bottom:6px;
    }
    .cal-nav {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      padding: 2px 12px;
      cursor: pointer;
    }
    .cal-nav:hover { background: var(--primary-dark); }
    .calendar-table {
      width:100%;
      border-collapse:collapse;
      text-align:center;
    }
    .calendar-table th {
      color: var(--primary-dark);
      font-size: .92rem;
      font-weight: 600;
      padding-bottom: 4px;
    }
    .calendar-table td {
      padding:4px 0;
      width:14.28%;
      font-size:.99rem;
      border-radius:5px;
      cursor:pointer;
      transition:background .11s;
    }
    .calendar-table td.today {
      background: var(--accent);
      color: var(--primary-dark);
      font-weight:700;
    }
    .calendar-table td:hover {
      background: var(--primary);
      color: #fff;
    }

    .recent-visits-section {
      flex:2 1 380px;
      min-width:280px;
      display:flex;
      flex-direction:column;
      background: var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:16px;
      overflow:hidden;
      margin-top: 12px;
    }
    .recent-visits-section .custom-header {
      background: var(--primary);
      color: #fff;
      border-bottom:none;
      border-radius:12px 12px 0 0;
      padding:12px 18px;
      font-weight:600;
      font-size:.95rem;
      letter-spacing:.4px;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .reservation-details-inner {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
    }
    .reservation-table-wrapper {
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:0;
      min-width:0;
    }
    .reservation-table-wrapper table {
      width:100%;
      min-width:600px;
      border-collapse:collapse;
      background:#fff;
      box-shadow:0 8px 30px rgba(32,39,55,0.08);
      font-size:.9rem;
      margin:0;
    }
    .reservation-table-wrapper thead th {
      text-align:center;
      padding:12px 16px;
      text-transform:uppercase;
      letter-spacing:.5px;
      font-weight:600;
      color:#444;
      background:transparent;
      border:none;
    }
    .reservation-table-wrapper tbody tr:nth-child(odd) { background:#f9fbfc; }
    .reservation-table-wrapper tbody tr:hover   { background:#e8f1fb; }
    .reservation-table-wrapper td {
      text-align:center;
      padding:12px 16px;
      border-top:1px solid #e8ecf1;
      color:#2f3e56;
      white-space:nowrap;
      vertical-align:middle;
    }

    .footer-hint {
      padding:10px 16px;
      font-size:.65rem;
      color:#6c757d;
      text-align:center;
      background:rgba(0,0,0,0.03);
      border-top:1px solid rgba(0,0,0,0.05);
      margin:0;
      width:100%;
      box-sizing:border-box;
      border-radius:0 0 16px 16px;
    }

    .btn-primary {
      background: var(--primary);
      border:none;
      font-weight:600;
      border-radius:5px;
    }
    .btn-primary:hover { background: var(--primary-dark); }

    @media (max-width:1000px) {
      .dashboard-main { flex-direction:column; gap:12px; }
      .welcome-card, .calendar-card, .recent-visits-section {
        width:100%;
        max-width:unset;
        min-width:unset;
      }
    }
    @media (max-width:768px) {
      .page-wrapper { padding: 0; }
      .dashboard-main { gap: 8px; }
      .welcome-card {
        flex-direction:column;
        text-align:center;
        padding:16px;
        border-radius:16px;
      }
      .pet-anim { margin:0 auto 16px auto; }
      .welcome-text { max-width:100%; }
      .welcome-card .btn { margin-top:12px; }
      .calendar-card { width:100%; margin:0; padding:0; }
      .calendar-inner { padding: 12px; }
      .recent-visits-section { width:100%; margin:0; }
      .reservation-table-wrapper {
        padding: 0;
      }
      .reservation-table-wrapper table {
        font-size:.8rem;
        min-width:unset;
      }
    }
    @media (max-width:480px) {
      .calendar-table th, .calendar-table td { padding:2px; font-size:.8rem; }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="dashboard-main">
      <!-- Welcome Card -->
      <div class="welcome-card">
        <div class="bubbles" aria-hidden="true">
          <div class="bubble" style="width:120px; height:120px; left:10%; bottom:5%; animation-delay:0s;"></div>
          <div class="bubble" style="width:80px; height:80px; left:25%; bottom:10%; animation-delay:3s;"></div>
          <div class="bubble" style="width:150px; height:150px; left:60%; bottom:0%; animation-delay:5s;"></div>
          <div class="bubble" style="width:100px; height:100px; left:75%; bottom:8%; animation-delay:2s;"></div>
          <div class="bubble" style="width:50px; height:50px; left:50%; bottom:3%; animation-delay:7s;"></div>
        </div>
        <div class="pet-anim">
          <svg viewBox="0 0 100 100" class="pet-svg" aria-label="Pet icon">
            <circle cx="50" cy="50" r="45" fill="rgba(255,255,255,0.15)" />
            <circle class="pad" cx="35" cy="40" r="8" />
            <circle class="pad" cx="65" cy="40" r="8" />
            <circle class="pad" cx="35" cy="65" r="8" />
            <circle class="pad" cx="65" cy="65" r="8" />
            <circle class="center-pad" cx="50" cy="55" r="12" />
          </svg>
        </div>
        <div class="welcome-text">
          <div class="welcome-title">Welcome back,</div>
          <div class="welcome-user"><%= username %>!</div>
          <div class="welcome-msg">
            Let’s check your pet's health.<br>
            Care with us—keep them happy and healthy.
          </div>
          <button class="btn"
            onclick="document.querySelector('.menu-item[data-content=&quot;consult&quot;]')?.click()">
            Consult your pet
          </button>
        </div>
      </div>

      <!-- Calendar Card -->
      <div class="calendar-card card">
        <div class="custom-header">Upcoming Visit</div>
        <div class="calendar-inner">
          <div class="calendar-header">
            <button id="prevMonth" class="cal-nav">&lt;</button>
            <span id="calendarMonth"></span>
            <button id="nextMonth" class="cal-nav">&gt;</button>
          </div>
          <table class="calendar-table">
            <thead>
              <tr>
                <th>Su</th><th>Mo</th><th>Tu</th><th>We</th>
                <th>Th</th><th>Fr</th><th>Sa</th>
              </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Visits Section -->
    <div class="recent-visits-section">
      <div class="custom-header">Recent Visits</div>
      <div class="reservation-details-inner">
        <div class="reservation-table-wrapper">
          <table class="mb-0">
            <thead>
              <tr>
                <th>Pet Name</th>
                <th>Date of Visit</th>
                <th>Consultation</th>
              </tr>
            </thead>
            <tbody>
              <% if (recentVisits && recentVisits.length) { %>
                <% recentVisits.forEach(function(visit) { %>
                  <tr>
                    <td><%= visit.pets.map(p => p.petName).join(', ') %></td>
                    <td>
                      <% if (visit.schedule && visit.schedule.scheduleDate) { %>
                        <%= formatVisitDate(visit.schedule.scheduleDate) %>
                      <% } else { %>
                        <%= formatVisitDate(visit.createdAt) %>
                      <% } %>
                    </td>
                    <td>
                      <button class="btn btn-primary btn-sm"
                              onclick="viewRecentVisit('<%= visit._id %>')">
                        View Details
                      </button>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr><td colspan="3" class="text-center">No recent visits found.</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="footer-hint">
          Recent visit data is read-only. Click view for full details.
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="recentVisitModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Visit Details</h5>
            <button type="button" class="close text-white" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body p-4" id="recentVisitDetails"></div>
          <div class="modal-footer">
            <button class="btn btn-secondary px-4" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script>
    function buildCalendar(date = new Date()) {
      const month = date.getMonth(), year = date.getFullYear();
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();
      const body = document.getElementById('calendarBody'), label = document.getElementById('calendarMonth');
      if (!body || !label) return;
      label.textContent = date.toLocaleString('default',{month:'long',year:'numeric'});
      let days = [];
      for (let i = 0; i < firstDay; i++) days.push('');
      for (let d = 1; d <= lastDate; d++) days.push(d);
      while (days.length % 7) days.push('');
      let html = '';
      for (let r = 0; r < days.length / 7; r++) {
        html += '<tr>';
        for (let c = 0; c < 7; c++) {
          const d = days[r * 7 + c];
          const today = new Date();
          const isToday = d === today.getDate() &&
                          month === today.getMonth() &&
                          year === today.getFullYear();
          html += `<td class="${isToday ? 'today' : ''}">${d || ''}</td>`;
        }
        html += '</tr>';
      }
      body.innerHTML = html;
      buildCalendar.current = { month, year };
    }
    buildCalendar();
    document.getElementById('prevMonth').onclick = () => {
      const { month, year } = buildCalendar.current;
      buildCalendar(new Date(year, month - 1, 1));
    };
    document.getElementById('nextMonth').onclick = () => {
      const { month, year } = buildCalendar.current;
      buildCalendar(new Date(year, month + 1, 1));
    };

    function formatVisitDateJS(date) {
      const d = new Date(date);
      return `${d.toLocaleString('en-US', { month: 'long' }).toLowerCase()} ${d.getDate()} ${d.getFullYear()}`;
    }
    function viewRecentVisit(id) {
      $('.modal').modal('hide');
      $.ajax({
        url: '/customer/get-consultation',
        method: 'GET',
        data: { reservationId: id },
        success(response) {
          if (!response.success) return alert(response.message);
          const r = response.reservation;
          let html = '<div class="container-fluid">';
          html += '<div class="detail-row"><div class="detail-label">Pet(s):</div><div class="detail-value">' + (r.pets.map(p => p.petName).join(', ') || 'N/A') + '</div></div>';
          html += '<div class="detail-row"><div class="detail-label">Concern:</div><div class="detail-value">' + (r.concerns || 'N/A') + '</div></div>';
          const visitDate = r.schedule?.scheduleDate || r.createdAt;
          html += '<div class="detail-row"><div class="detail-label">Date:</div><div class="detail-value">' + formatVisitDateJS(visitDate) + '</div></div>';
          html += '<div class="detail-row"><div class="detail-label">Time:</div><div class="detail-value">' + (r.time || 'N/A') + '</div></div>';
          if (r.physicalExam) {
            html += '<div class="detail-row"><div class="detail-label">Physical Exam:</div><div class="detail-value"></div></div>';
            html += '<table class="physical-table"><thead><tr><th>Weight</th><th>Temperature</th><th>Observations</th></tr></thead><tbody><tr>';
            html += '<td>' + (r.physicalExam.weight || 'N/A') + '</td>';
            html += '<td>' + (r.physicalExam.temperature || 'N/A') + '</td>';
            html += '<td>' + (r.physicalExam.observations || 'N/A') + '</td>';
            html += '</tr></tbody></table>';
          }
          if (r.diagnosis) {
            html += '<div class="detail-row"><div class="detail-label">Diagnosis:</div><div class="detail-value"></div></div>';
            html += '<div class="diagnosis-card">' + r.diagnosis + '</div>';
          }
          if (r.services?.length) {
            html += '<div class="detail-row"><div class="detail-label">Services:</div><div class="detail-value"></div></div>';
            html += '<table class="services-table"><thead><tr><th>Service</th><th>Details</th><th>Download</th></tr></thead><tbody>';
            r.services.forEach(s => {
              let fileUrl = s.file || '';
              if (fileUrl) {
                fileUrl = fileUrl.replace(/^public/, '');
                if (!fileUrl.startsWith('/')) fileUrl = '/' + fileUrl;
                if (!/^https?:\/\//.test(fileUrl)) {
                  fileUrl = window.location.origin + fileUrl;
                }
              }
              html += '<tr><td>' + s.serviceName + '</td><td>' + (s.details || '—') + '</td><td>' +
                      (fileUrl ? '<a href="' + fileUrl + '" download>Download</a>' : '—') +
                      '</td></tr>';
            });
            html += '</tbody></table>';
          }
          if (r.medications?.length) {
            html += '<div class="detail-row"><div class="detail-label">Medications:</div><div class="detail-value">' +
                    '<button class="btn btn-outline-secondary btn-sm" onclick="downloadPrescription(\'' + r._id + '\')">' +
                    '<i class="fas fa-file-download"></i> Download Prescription</button></div></div>';
            html += '<table class="medication-table"><thead><tr><th>Name</th><th>Qty</th><th>Dosage</th><th>Remarks</th></tr></thead><tbody>';
            r.medications.forEach(m => {
              html += '<tr><td>' + (m.name || m.medicationName || '—') + '</td>';
              html += '<td>' + (m.quantity || '—') + '</td>';
              html += '<td>' + (m.dosage || '—') + '</td>';
              html += '<td>' + (m.remarks || '—') + '</td></tr>';
            });
            html += '</tbody></table>';
          }
          if (r.confinementStatus?.length) {
            html += '<div class="detail-row"><div class="detail-label">Confinement:</div><div class="detail-value">' + r.confinementStatus.join(', ') + '</div></div>';
          }
          if (r.notes) {
            html += '<div class="detail-row"><div class="detail-label">Additional Notes:</div><div class="detail-value">' + r.notes + '</div></div>';
          }
          if (r.doctor) {
            html += '<div class="detail-row"><div class="detail-label">Doctor:</div><div class="detail-value">' + r.doctor.username + '</div></div>';
          }
          html += '</div>';
          $('#recentVisitDetails').html(html);
          $('#recentVisitModal').modal('show');
        },
        error() {
          alert('Server error loading visit details.');
        }
      });
    }
    function downloadPrescription(reservationId) {
      window.open('/customer/prescription/' + reservationId, '_blank');
    }
  </script>
</body>
</html>
